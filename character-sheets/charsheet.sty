\RequirePackage[margin=7mm]{geometry}
\RequirePackage{tikz}
\RequirePackage{times}
\RequirePackage{xcolor}
\RequirePackage{environ}
\RequirePackage{tabularx}
\RequirePackage{booktabs}
\usetikzlibrary{calc}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes}

% Define colors for different sections
\colorlet{stats}{blue!10!white}
\colorlet{proficiencies}{yellow!12!white}
\colorlet{attacks}{orange!25!white}
\colorlet{magic}{red!12!white}
\colorlet{mypurple}{red!40!blue}
\colorlet{features}{magenta!16!white}
\colorlet{playername}{green!90!yellow!8!white}
\colorlet{teal}{blue!40!green}
\colorlet{equipment}{playername}
\colorlet{hpetc}{gray!40!white}

\newif\ifcaster
\casterfalse

\tikzset{
  dndbox/.style={ outer sep=1.5pt },  % make decorations work
  dndleft/.style={
    dndbox,
    minimum width=67mm,
  },
  dndright/.style={
    dndbox,
    minimum width=128mm,
  },
  dndfull/.style={
    dndbox,
    minimum width=198mm,
  },
  dndhits/.style={
    dndbox,
    minimum height=21mm,
  },
}

\tikzset{
  magic/.style={
    dndright,
    fill=magic,
  },
  attacks/.style={
    dndright,
    fill=attacks,
  },
  features/.style={
    dndright,
    fill=features,
  },
  equipment/.style={
    dndleft,
    fill=equipment,
  },
}

\tikzset{
  proficiencies/.style={
    dndbox,
    minimum width=37mm,
    fill=proficiencies,
  },
}

% dndbox should create a node

%%  % inside a tikzpicture
%%  \node[minimum width=60mm,   % desired width
%%        minimum height=35mm,  % desired height
%%        inner sep=0pt,        % no extra padding
%%        outer sep=0pt]        % (optional) no extra margin
%%        (MyBox) at (10mm,5mm) {};

\newcommand\dndnode[4]{%
   % name, origin, w, h
  \node[
      anchor=south west,
      rectangle,
      minimum width=#3,   % desired width
      minimum height=#4,  % desired height
      inner sep=0pt,        % no extra padding
      outer sep=0pt]        % (optional) no extra margin
      (#1) at (#2) {};
}

\newcommand\dndnodebox[4]{%
  \dndnode{#1}{#2}{#3}{#4}
  \dndbox{#2}{#3}{#4}
}


% Decorative box macro for D&D character sheets
% Usage: \dndbox{origin}{width}{height}
% where origin may be `x,y` or a coordinate name
\newcommand{\dndbox}[3]{%
  % Parameters: #1 = x,y, #2 = width, #3 = height
  \path (#1) coordinate (dndboxll);
  \dndboxhere{#2}{#3}
}
\newcommand\dndfill[4]{%
  \fill[#4] (#1) +(1mm,1mm) rectangle +(#2-1mm,#3-1mm);
}
\def\south{south}
\newcommand\dndlabeledbox[6][south]{% anchor, add color and label
  \dndfill{#2}{#3}{#4}{#5}
  \dndbox{#2}{#3}{#4}
  \def\anchor{#1}
  \ifx\anchor\south
    \path (#2) ++(#3/2,0mm) node [inner sep=6pt,anchor=#1] {\textsf{#6}};
  \else
    \path (#2) node [inner sep=6pt,anchor=#1] {\textsf{#6}};
  \fi
}
  

\newcommand{\dndboxhere}[2]{%
  % draw a decorative box with the lower left corner at node dndboxll
  % and with a width and height given by parameters #1 and #2
  \pgfmathsetmacro{\cornersize}{0.15} % Size of corner decorations
  \pgfmathsetmacro{\inset}{0.05} % Inset for inner lines
  
  % Define coordinates
  \path (dndboxll)     coordinate (ll)
             +(#1, 0)  coordinate (lr)
             +(#1, #2) coordinate (ur)
             +(0, #2)  coordinate (ul);
  
  % Main outer frame (heavy lines)
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) -- ($(lr) + (-\cornersize, 0)$)
    ($(lr) + (0, \cornersize)$) -- ($(ur) + (0, -\cornersize)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ul) + (\cornersize, 0)$)
    ($(ul) + (0, -\cornersize)$) -- ($(ll) + (0, \cornersize)$);
  
  % Corner decorations (ornate corners)
  % Lower-left corner
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) arc (0:90:\cornersize)
    ($(ll) + (0, \cornersize)$) -- ($(ll) + (0, \cornersize/2)$)
    ($(ll) + (\cornersize, 0)$) -- ($(ll) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ll) + (\cornersize*0.7, \cornersize*0.3)$) arc (0:90:\cornersize*0.3);
    
  % Lower-right corner
  \draw[line width=1.5pt] 
    ($(lr) + (-\cornersize, 0)$) arc (180:90:\cornersize)
    ($(lr) + (0, \cornersize)$) -- ($(lr) + (0, \cornersize/2)$)
    ($(lr) + (-\cornersize, 0)$) -- ($(lr) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(lr) + (-\cornersize*0.7, \cornersize*0.3)$) arc (180:90:\cornersize*0.3);
    
  % Upper-right corner
  \draw[line width=1.5pt] 
    ($(ur) + (-\cornersize, 0)$) arc (180:270:\cornersize)
    ($(ur) + (0, -\cornersize)$) -- ($(ur) + (0, -\cornersize/2)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ur) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ur) + (-\cornersize*0.7, -\cornersize*0.3)$) arc (180:270:\cornersize*0.3);
    
  % Upper-left corner
  \draw[line width=1.5pt] 
    ($(ul) + (\cornersize, 0)$) arc (0:-90:\cornersize)
    ($(ul) + (0, -\cornersize)$) -- ($(ul) + (0, -\cornersize/2)$)
    ($(ul) + (\cornersize, 0)$) -- ($(ul) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ul) + (\cornersize*0.7, -\cornersize*0.3)$) arc (0:-90:\cornersize*0.3);
  
  % Inner frame lines (lighter)
  \draw[line width=0.5pt]
    ($(ll) + (\inset, \inset)$) rectangle ($(ur) + (-\inset, -\inset)$);
  
  % Double line effect on sides
  \draw[line width=0.3pt]
    ($(ll) + (\inset*2, \cornersize*1.5)$) -- ($(ul) + (\inset*2, -\cornersize*1.5)$)
    ($(lr) + (-\inset*2, \cornersize*1.5)$) -- ($(ur) + (-\inset*2, -\cornersize*1.5)$);
}

\newcommand{\dndboxnodey}[1]{%
  % Draw a decorative box around the bounding box of node #1
  \pgfmathsetmacro{\cornersize}{0.15} % Size of corner decorations
  \pgfmathsetmacro{\inset}{0.05} % Inset for inner lines
  
  % Get the bounding box of the node
  \path (#1.south west) coordinate (ll)
        (#1.south east) coordinate (lr)
        (#1.north east) coordinate (ur)
        (#1.north west) coordinate (ul);
  
  % Main outer frame (heavy lines)
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) -- ($(lr) + (-\cornersize, 0)$)
    ($(lr) + (0, \cornersize)$) -- ($(ur) + (0, -\cornersize)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ul) + (\cornersize, 0)$)
    ($(ul) + (0, -\cornersize)$) -- ($(ll) + (0, \cornersize)$);
  
  % Corner decorations (ornate corners)
  % Lower-left corner
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) arc (0:90:\cornersize)
    ($(ll) + (0, \cornersize)$) -- ($(ll) + (0, \cornersize/2)$)
    ($(ll) + (\cornersize, 0)$) -- ($(ll) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ll) + (\cornersize*0.7, \cornersize*0.3)$) arc (0:90:\cornersize*0.3);
    
  % Lower-right corner
  \draw[line width=1.5pt] 
    ($(lr) + (-\cornersize, 0)$) arc (180:90:\cornersize)
    ($(lr) + (0, \cornersize)$) -- ($(lr) + (0, \cornersize/2)$)
    ($(lr) + (-\cornersize, 0)$) -- ($(lr) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(lr) + (-\cornersize*0.7, \cornersize*0.3)$) arc (180:90:\cornersize*0.3);
    
  % Upper-right corner
  \draw[line width=1.5pt] 
    ($(ur) + (-\cornersize, 0)$) arc (180:270:\cornersize)
    ($(ur) + (0, -\cornersize)$) -- ($(ur) + (0, -\cornersize/2)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ur) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ur) + (-\cornersize*0.7, -\cornersize*0.3)$) arc (180:270:\cornersize*0.3);
    
  % Upper-left corner
  \draw[line width=1.5pt] 
    ($(ul) + (\cornersize, 0)$) arc (0:-90:\cornersize)
    ($(ul) + (0, -\cornersize)$) -- ($(ul) + (0, -\cornersize/2)$)
    ($(ul) + (\cornersize, 0)$) -- ($(ul) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ul) + (\cornersize*0.7, -\cornersize*0.3)$) arc (0:-90:\cornersize*0.3);
  
  % Inner frame lines (lighter)
  \draw[line width=0.5pt]
    ($(ll) + (\inset, \inset)$) rectangle ($(ur) + (-\inset, -\inset)$);
  
  % Double line effect on sides
  \draw[line width=0.3pt]
    ($(ll) + (\inset*2, \cornersize*1.5)$) -- ($(ul) + (\inset*2, -\cornersize*1.5)$)
    ($(lr) + (-\inset*2, \cornersize*1.5)$) -- ($(ur) + (-\inset*2, -\cornersize*1.5)$);
}

\newcommand{\dndboxold}[4]{%
  % Parameters: #1 = x, #2 = y, #3 = width, #4 = height
  \pgfmathsetmacro{\cornersize}{0.15} % Size of corner decorations
  \pgfmathsetmacro{\inset}{0.05} % Inset for inner lines
  
  % Define coordinates
  \coordinate (ll) at (#1, #2);
  \coordinate (lr) at (#1 + #3, #2);
  \coordinate (ul) at (#1, #2 + #4);
  \coordinate (ur) at (#1 + #3, #2 + #4);
  
  % Main outer frame (heavy lines)
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) -- ($(lr) + (-\cornersize, 0)$)
    ($(lr) + (0, \cornersize)$) -- ($(ur) + (0, -\cornersize)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ul) + (\cornersize, 0)$)
    ($(ul) + (0, -\cornersize)$) -- ($(ll) + (0, \cornersize)$);
  
  % Corner decorations (ornate corners)
  % Lower-left corner
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) arc (0:90:\cornersize)
    ($(ll) + (0, \cornersize)$) -- ($(ll) + (0, \cornersize/2)$)
    ($(ll) + (\cornersize, 0)$) -- ($(ll) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ll) + (\cornersize*0.7, \cornersize*0.3)$) arc (0:90:\cornersize*0.3);
    
  % Lower-right corner
  \draw[line width=1.5pt] 
    ($(lr) + (-\cornersize, 0)$) arc (180:90:\cornersize)
    ($(lr) + (0, \cornersize)$) -- ($(lr) + (0, \cornersize/2)$)
    ($(lr) + (-\cornersize, 0)$) -- ($(lr) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(lr) + (-\cornersize*0.7, \cornersize*0.3)$) arc (180:90:\cornersize*0.3);
    
  % Upper-right corner
  \draw[line width=1.5pt] 
    ($(ur) + (-\cornersize, 0)$) arc (180:270:\cornersize)
    ($(ur) + (0, -\cornersize)$) -- ($(ur) + (0, -\cornersize/2)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ur) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ur) + (-\cornersize*0.7, -\cornersize*0.3)$) arc (180:270:\cornersize*0.3);
    
  % Upper-left corner
  \draw[line width=1.5pt] 
    ($(ul) + (\cornersize, 0)$) arc (0:-90:\cornersize)
    ($(ul) + (0, -\cornersize)$) -- ($(ul) + (0, -\cornersize/2)$)
    ($(ul) + (\cornersize, 0)$) -- ($(ul) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ul) + (\cornersize*0.7, -\cornersize*0.3)$) arc (0:-90:\cornersize*0.3);
  
  % Inner frame lines (lighter)
  \draw[line width=0.5pt]
    ($(ll) + (\inset, \inset)$) rectangle ($(ur) + (-\inset, -\inset)$);
  
  % Double line effect on sides
  \draw[line width=0.3pt]
    ($(ll) + (\inset*2, \cornersize*1.5)$) -- ($(ul) + (\inset*2, -\cornersize*1.5)$)
    ($(lr) + (-\inset*2, \cornersize*1.5)$) -- ($(ur) + (-\inset*2, -\cornersize*1.5)$);
}

% dndsection environment - stores parameters for use inside tikzpicture

\newlength\dndtextwidth

\NewEnviron{dndsection}[6]{%
  \begingroup
  \newcommand{\dndsectionx}{#1}%
  \newcommand{\dndsectiony}{#2}%
  \newcommand{\dndsectionwidth}{#3}%
  \newcommand{\dndsectionheight}{#4}%
  \newcommand{\dndsectiontitle}{#5}%
  \newcommand{\dndsectioncolor}{#6}%
  % Fill background
  \fill[\dndsectioncolor] (\dndsectionx + 1mm, \dndsectiony + 1mm) rectangle (\dndsectionx + \dndsectionwidth - 1mm, \dndsectiony + \dndsectionheight - 1mm);
  
  % Draw the decorative box
  \dndbox{\dndsectionx,\dndsectiony}{\dndsectionwidth}{\dndsectionheight}
  
  % Place the title at the bottom center
  \node[font=\footnotesize\scshape, anchor=south] at (\dndsectionx + \dndsectionwidth/2, \dndsectiony + 1mm) {\sffamily {\dndsectiontitle}};
  
  % Calculate minipage width
 \setlength{\dndtextwidth}{\dndsectionwidth}
 \addtolength\dndtextwidth{-2\fboxsep}
 \addtolength\dndtextwidth{-2mm}

  % Place content in a minipage
  \node[anchor=north west, inner sep=0] at (\dndsectionx + \fboxsep + 1mm, \dndsectiony+\dndsectionheight - \fboxsep - 1mm) {%
   \begin{minipage}{\dndtextwidth}%
     \BODY%
   \end{minipage}%
  };
  \endgroup
}

\newlength\leftwidth
\newlength\rightwidth
\leftwidth=6.5cm
\rightwidth=12.8cm
\newlength\rightx
\rightx=7.15cm


% Specific section environments with fixed positions
% Use different body names to avoid conflicts
\environbodyname\attacksbody
\NewEnviron{attackssection}{%
  \ifcaster
    \def\y{152mm}%
    \def\h{26mm}
  \else
    \def\y{129mm}%
    \def\h{49mm}
  \fi  
  \begin{dndsection}{\rightx}{\y}{\rightwidth}{\h}{ATTACKS}{attacks}
    \attacksbody
  \end{dndsection}
}[\ignorespacesafterend]
% y = 128mm for noncasters


\environbodyname\featuresbody

%%\NewEnviron{featuressection}{%  noncaster
%%  \begin{dndsection}{\rightx}{55mm}{\rightwidth}{70mm}{FEATURES}{features}
%%    \featuresbody
%%  \end{dndsection}
%%}[\ignorespacesafterend]
%%

\NewEnviron{featuressection}{%  caster
  \begin{dndsection}{\rightx}{0mm}{\rightwidth}{42mm}{FEATURES}{features}
    \featuresbody
  \end{dndsection}
}[\ignorespacesafterend]


\environbodyname\magicbody  
\NewEnviron{magicsection}{%
  \dndnode{magic}{\rightx,44.5mm}{\rightwidth}{105mm};
  \begin{dndsection}{\rightx}{44.5mm}{\rightwidth}{105mm}{MAGIC}{magic}
    \magicbody
  \end{dndsection}
}[\ignorespacesafterend]

\environbodyname\equipmentbody
\NewEnviron{equipmentsection}{%
  \dndnode{equipment}{0mm,0mm}{68mm}{53mm}
  \begin{dndsection}{0mm}{0mm}{68mm}{53mm}{EQUIPMENT}{equipment}
    \equipmentbody
  \end{dndsection}
}[\ignorespacesafterend]

\environbodyname\proficienciesbody
\NewEnviron{proficienciessection}{%
  \begin{dndsection}{30mm}{55mm}{38mm}{160mm}{PROFICIENCIES}{proficiencies}
    \proficienciesbody
  \end{dndsection}
}[\ignorespacesafterend]



\newenvironment{nobullets}
  {\begin{list}{}{%
      \setlength{\leftmargin}{0pt}% no indentation
      \setlength{\labelwidth}{0pt}%
      \setlength{\labelsep}{0pt}%
      \setlength{\itemindent}{0pt}%
      \setlength{\topsep}{0pt}% space before/after the list
      \setlength{\partopsep}{0pt}%
      \setlength{\parsep}{0pt}%
      \setlength{\itemsep}{0.5\smallskipamount}% space between items
      \renewcommand*{\makelabel}[1]{}% suppress the bullet
  }}%
  {\end{list}}


\newenvironment{featurestab}
  {\renewcommand\arraystretch{1.5}%
   \begin{tabular}{>{\raggedright\arraybackslash\itshape}p{26mm}>{\raggedright\arraybackslash}p{93mm}}}
  {\end{tabular}}

\newenvironment{spellstab}
  {\renewcommand\arraystretch{1.5}%
   \begin{tabular}{>{\raggedright\arraybackslash\itshape}p{26mm}>{\raggedright\arraybackslash}p{93mm}}}
  {\end{tabular}}

\newcommand\cantripsheader{%
  \multicolumn2{l}{\textsf{CANTRIPS}}%
}

\newcommand{\checkboxes}[1]{%
  \begingroup
  \count0=#1\relax
  \loop
    \ifnum\count0>0
      $\circ$\,
      \ifnum\count0>1~\fi
      \advance\count0 by -1
  \repeat
  \endgroup
}

\newcommand\hpetcll{\rightx + 30mm, 184mm}

\newcommand\hpbackground{
  \node (hpbackground) 
   at (splash.south east)
   [fill=hpetc,anchor=north east,minimum width=98mm, minimum height=44.5mm] 
   { };
}

\newcommand\spellsheader[2]{%
  \multicolumn2{l}{\textsf{LEVEL~#1 \checkboxes{#2}/day}}%
}


\newenvironment{attackstab}
  {\renewcommand\arraystretch{1.2}%
   \tabcolsep=0.5\tabcolsep
   \small
   \begin{tabular}{@{}cccccc@{}}
   \multicolumn1{@{}l}{\textsf{NAME}}&
   \textsf{ATTACK}&
   \textsf{DAMAGE}&
   \textsf{TYPE}&
   \textsf{RANGE}&
   \textsf{AMMO}\\
   \midrule
  }
  {\end{tabular}}


%-------------------------------------------------------------
%  Shield shape: top made of two quadratic curves, tapered
%  sides meeting at a point.  Works with minimum width/height,
%  inner sep, anchors, etc.
%-------------------------------------------------------------

\pgfdeclareshape{kite}{
  % Inherit anchors from rectangle
  \inheritsavedanchors[from=rectangle]
  \inheritanchor[from=rectangle]{center}
  \inheritanchor[from=rectangle]{north}
  \inheritanchor[from=rectangle]{south}
  \inheritanchor[from=rectangle]{east}
  \inheritanchor[from=rectangle]{west}
  \inheritanchor[from=rectangle]{north east}
  \inheritanchor[from=rectangle]{north west}
  \inheritanchor[from=rectangle]{south east}
  \inheritanchor[from=rectangle]{south west}
  
  % Background path (defines the shape outline)
  \backgroundpath{
    % Get the corners
    \southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
    \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
    
    % Calculate 2/3 up the west edge
    \pgf@yc=\pgf@ya
    \advance\pgf@yc by 0.667\pgf@yb
    \advance\pgf@yc by -0.667\pgf@ya
    
    % Draw line from north anchor to 2/3 up west edge
    \pgfpathmoveto{\pgfpoint{0.5\pgf@xa + 0.5\pgf@xb}{\pgf@yb}}
    \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yc}}
  }
}

\newdimen\my@xa
\newdimen\my@ya
\newdimen\my@xb
\newdimen\my@yb
\newdimen\my@xc
\newdimen\my@yc

\newdimen\my@Nx
\newdimen\my@Ny
\newdimen\my@Ex
\newdimen\my@Ey
\newdimen\my@Wx
\newdimen\my@Wy
\newdimen\my@Sx
\newdimen\my@Sy
\newdimen\my@Cx
\newdimen\my@Cy

\def\shieldTopDelta{3}
\def\shieldBottomDelta{7}

% Here is a {\LaTeX} macro that is meant to draw a shield shape.  I
% started with a kite shape using straight lines to connect
% north-west-south-east, then replaced the first straight line with a
% quadratic curve.  Emulating the code that is there, will you please
% replace the other three straight lines with similar curves?

\pgfdeclareshape{shield}{
  % Inherit anchors from rectangle
  \inheritsavedanchors[from=rectangle]
  \inheritanchor[from=rectangle]{center}
  \inheritanchor[from=rectangle]{north}
  \inheritanchor[from=rectangle]{south}
  \inheritanchor[from=rectangle]{east}
  \inheritanchor[from=rectangle]{west}
  \inheritanchor[from=rectangle]{north east}
  \inheritanchor[from=rectangle]{north west}
  \inheritanchor[from=rectangle]{south east}
  \inheritanchor[from=rectangle]{south west}

  \anchor{ac}{
    \southwest \my@Wx=\pgf@x \my@Sy=\pgf@y
    \northeast \my@Ex=\pgf@x \my@Ny=\pgf@y
    \pgfpoint{0.5\my@Wx+0.5\my@Ex}{0.4\my@Sy+0.6\my@Ny}}     


  % Background path (defines the shape outline)
  \backgroundpath{
    % Get the corners
    \southwest \my@Wx=\pgf@x \my@Sy=\pgf@y
    \northeast \my@Ex=\pgf@x \my@Ny=\pgf@y
    % p + t(q - p) == (1-t)*p + t * q
    \pgfmathsetlength\my@Cx{0.5\my@Wx+0.5\my@Ex}
    \pgfmathsetlength\my@Cy{0.2\my@Sy+0.80\my@Ny}
    \def\north{\pgfpoint{\my@Cx}{\my@Ny}}
    \def\west {\pgfpoint{\my@Wx}{\my@Cy}}
    \def\south{\pgfpoint{\my@Cx}{\my@Sy}}
    \def\east {\pgfpoint{\my@Ex}{\my@Cy}}

    \anchor{ac}{\pgfpointlineattime{0.8}{\south}{\north}}

    % Draw kite shape with curved lines
    \pgfpathmoveto{\north}
    
    % Curve from north to west
    \pgfpointlineattime{0.5}{\west}{\north} % bisector
    \pgfgetlastxy{\my@xa}{\my@ya}
    \pgfpointdiff{\west}{\north}
    \pgfgetlastxy{\my@xb}{\my@yb} % note swap
    \pgfpathquadraticcurveto
        {\pgfpointadd{\pgfpoint{\my@xa}{\my@ya}}
                     {\pgfpointscale{\shieldTopDelta}{\pgfpointnormalised{\pgfpoint{\my@yb}{-\my@xb}}}}}
        {\west}
    
    % Curve from west to south
    \pgfpointlineattime{0.5}{\south}{\west} % bisector
    \pgfgetlastxy{\my@xa}{\my@ya}
    \pgfpointdiff{\south}{\west}
    \pgfgetlastxy{\my@xb}{\my@yb} % note swap
    \pgfpathquadraticcurveto
        {\pgfpointadd{\pgfpoint{\my@xa}{\my@ya}}
                     {\pgfpointscale{\shieldBottomDelta}{\pgfpointnormalised{\pgfpoint{-\my@yb}{\my@xb}}}}}
        {\south}
    
    % Curve from south to east
    \pgfpointlineattime{0.5}{\east}{\south} % bisector
    \pgfgetlastxy{\my@xa}{\my@ya}
    \pgfpointdiff{\east}{\south}
    \pgfgetlastxy{\my@xb}{\my@yb} % note swap
    \pgfpathquadraticcurveto
        {\pgfpointadd{\pgfpoint{\my@xa}{\my@ya}}
                     {\pgfpointscale{\shieldBottomDelta}{\pgfpointnormalised{\pgfpoint{-\my@yb}{\my@xb}}}}}
        {\east}
    
    % Curve from east to north (closing the path)
    \pgfpointlineattime{0.5}{\north}{\east} % bisector
    \pgfgetlastxy{\my@xa}{\my@ya}
    \pgfpointdiff{\north}{\east}
    \pgfgetlastxy{\my@xb}{\my@yb} % note swap
    \pgfpathquadraticcurveto
        {\pgfpointadd{\pgfpoint{\my@xa}{\my@ya}}
                     {\pgfpointscale{\shieldTopDelta}{\pgfpointnormalised{\pgfpoint{\my@yb}{-\my@xb}}}}}
        {\north}
  }
}



\newcommand{\dndboxnode}[1]{%
  % Draw a decorative box around the node #1 using inner separation boundaries
  \pgfmathsetmacro{\cornersize}{0.15} % Size of corner decorations
  \pgfmathsetmacro{\inset}{0.05} % Inset for inner lines
  
  % Get the node's shape and extract inner dimensions
  \begingroup
    \pgfpointanchor{#1}{center}
    \pgf@xa=\pgf@x
    \pgf@ya=\pgf@y
    
    % Get the text box dimensions (excluding inner sep)
    \pgfpointanchor{#1}{text}
    \advance\pgf@x by -\pgf@xa
    \advance\pgf@y by -\pgf@ya
    \pgfmathsetmacro{\textwidth}{2*abs(\pgf@x)*0.03514598}
    \pgfmathsetmacro{\textheight}{2*abs(\pgf@y)*0.03514598}
    
    % Use a more direct approach with the node's actual boundaries
    % Calculate positions based on the node's text area
    \pgfextractx{\pgf@xa}{\pgfpointanchor{#1}{west}}
    \pgfextractx{\pgf@xb}{\pgfpointanchor{#1}{east}}
    \pgfextracty{\pgf@ya}{\pgfpointanchor{#1}{south}}
    \pgfextracty{\pgf@yb}{\pgfpointanchor{#1}{north}}
    
    % Get inner sep values from the node
    \pgfkeysgetvalue{/pgf/inner xsep}{\innerxsep}
    \pgfkeysgetvalue{/pgf/inner ysep}{\innerysep}
    \ifx\innerxsep\pgfkeysnovalue
      \def\innerxsep{.3333em}
    \fi
    \ifx\innerysep\pgfkeysnovalue  
      \def\innerysep{.3333em}
    \fi
    
    % Convert inner sep to points
    \pgfmathsetlengthmacro{\innerxseppt}{\innerxsep}
    \pgfmathsetlengthmacro{\inneryseppt}{\innerysep}
    
    % Define coordinates at inner separation boundaries
    % We need to account for the cornersize to ensure decorations stay within bounds
    \pgfmathsetlengthmacro{\totalinsetx}{\innerxseppt + \cornersize cm}
    \pgfmathsetlengthmacro{\totalinsety}{\inneryseppt + \cornersize cm}
    
    \coordinate (ll) at ($(#1.south west) + (\totalinsetx, \totalinsety)$);
    \coordinate (lr) at ($(#1.south east) + (-\totalinsetx, \totalinsety)$);
    \coordinate (ur) at ($(#1.north east) + (-\totalinsetx, -\totalinsety)$);
    \coordinate (ul) at ($(#1.north west) + (\totalinsetx, -\totalinsety)$);
  \endgroup
  
  % Main outer frame (heavy lines)
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) -- ($(lr) + (-\cornersize, 0)$)
    ($(lr) + (0, \cornersize)$) -- ($(ur) + (0, -\cornersize)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ul) + (\cornersize, 0)$)
    ($(ul) + (0, -\cornersize)$) -- ($(ll) + (0, \cornersize)$);
  
  % Corner decorations (ornate corners)
  % Lower-left corner
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) arc (0:90:\cornersize)
    ($(ll) + (0, \cornersize)$) -- ($(ll) + (0, \cornersize/2)$)
    ($(ll) + (\cornersize, 0)$) -- ($(ll) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ll) + (\cornersize*0.7, \cornersize*0.3)$) arc (0:90:\cornersize*0.3);
    
  % Lower-right corner
  \draw[line width=1.5pt] 
    ($(lr) + (-\cornersize, 0)$) arc (180:90:\cornersize)
    ($(lr) + (0, \cornersize)$) -- ($(lr) + (0, \cornersize/2)$)
    ($(lr) + (-\cornersize, 0)$) -- ($(lr) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(lr) + (-\cornersize*0.7, \cornersize*0.3)$) arc (180:90:\cornersize*0.3);
    
  % Upper-right corner
  \draw[line width=1.5pt] 
    ($(ur) + (-\cornersize, 0)$) arc (180:270:\cornersize)
    ($(ur) + (0, -\cornersize)$) -- ($(ur) + (0, -\cornersize/2)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ur) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ur) + (-\cornersize*0.7, -\cornersize*0.3)$) arc (180:270:\cornersize*0.3);
    
  % Upper-left corner
  \draw[line width=1.5pt] 
    ($(ul) + (\cornersize, 0)$) arc (0:-90:\cornersize)
    ($(ul) + (0, -\cornersize)$) -- ($(ul) + (0, -\cornersize/2)$)
    ($(ul) + (\cornersize, 0)$) -- ($(ul) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ul) + (\cornersize*0.7, -\cornersize*0.3)$) arc (0:-90:\cornersize*0.3);
  
  % Inner frame lines (lighter)
  \draw[line width=0.5pt]
    ($(ll) + (\inset, \inset)$) rectangle ($(ur) + (-\inset, -\inset)$);
  
  % Double line effect on sides
  \draw[line width=0.3pt]
    ($(ll) + (\inset*2, \cornersize*1.5)$) -- ($(ul) + (\inset*2, -\cornersize*1.5)$)
    ($(lr) + (-\inset*2, \cornersize*1.5)$) -- ($(ur) + (-\inset*2, -\cornersize*1.5)$);
}


\newcommand{\dnddecorate}[1]{%
  % draw a decorative box on the named node
  \pgfmathsetmacro{\cornersize}{0.50015} % Size of corner decorations
  \pgfmathsetmacro{\inset}{0.1} % Inset for inner lines

  % 0.75pt is half of line width

  % Define coordinates
  \path (#1.south west) +(0.75pt,0.75pt) coordinate (ll)
        (#1.south east) +(-0.75pt,0.75pt) coordinate (lr)
        (#1.north west) +(0.75pt,-0.75pt) coordinate (ul)
         (#1.north east) +(-0.75pt,-0.75pt) coordinate (ur)
     ;
  
%   \draw[ultra thin] (ll) -- (lr) -- (ur) -- (ul) -- cycle;

%  \draw [blue]
%        (#2.south west) --
%        (#2.south east) --
%        (#2.north east) --
%        (#2.north west) --
%        cycle
%     ;




    \fill[white] (ll) -- +(\cornersize,0) arc (0:90:\cornersize) -- cycle;
    \fill[white] (lr) -- +(-\cornersize,0) arc (180:90:\cornersize) -- cycle;
    \fill[white] (ul) -- +(\cornersize,0) arc (0:-90:\cornersize) -- cycle;
    \fill[white] (ur) -- +(-\cornersize,0) arc (180:270:\cornersize) -- cycle;



  % Main outer frame (heavy lines)
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) -- ($(lr) + (-\cornersize, 0)$)
    ($(lr) + (0, \cornersize)$) -- ($(ur) + (0, -\cornersize)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ul) + (\cornersize, 0)$)
    ($(ul) + (0, -\cornersize)$) -- ($(ll) + (0, \cornersize)$);
  
  % Corner decorations (ornate corners)
  % Lower-left corner
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) arc (0:90:\cornersize)
%%    ($(ll) + (0, \cornersize)$) -- ($(ll) + (0, \cornersize/2)$)
%%    ($(ll) + (\cornersize, 0)$) -- ($(ll) + (\cornersize/2, 0)$)
     ;
  \draw[line width=0.8pt] 
    ($(ll) + (\cornersize*0.7, \cornersize*0.3)$) arc (0:90:\cornersize*0.3);
    
  % Lower-right corner
  \draw[line width=1.5pt] 
    ($(lr) + (-\cornersize, 0)$) arc (180:90:\cornersize);
%    ($(lr) + (0, \cornersize)$) -- ($(lr) + (0, \cornersize/2)$)
%    ($(lr) + (-\cornersize, 0)$) -- ($(lr) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(lr) + (-\cornersize*0.7, \cornersize*0.3)$) arc (180:90:\cornersize*0.3);
    
  % Upper-right corner
  \draw[line width=1.5pt] 
    ($(ur) + (-\cornersize, 0)$) arc (180:270:\cornersize);
%    ($(ur) + (0, -\cornersize)$) -- ($(ur) + (0, -\cornersize/2)$)
%    ($(ur) + (-\cornersize, 0)$) -- ($(ur) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ur) + (-\cornersize*0.7, -\cornersize*0.3)$) arc (180:270:\cornersize*0.3);
    
  % Upper-left corner
  \draw[line width=1.5pt] 
    ($(ul) + (\cornersize, 0)$) arc (0:-90:\cornersize);
%    ($(ul) + (0, -\cornersize)$) -- ($(ul) + (0, -\cornersize/2)$)
%    ($(ul) + (\cornersize, 0)$) -- ($(ul) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ul) + (\cornersize*0.7, -\cornersize*0.3)$) arc (0:-90:\cornersize*0.3);
  
  % Inner frame lines (lighter)
  \draw[line width=0.5pt]
    ($(ll) + (\inset, \inset)$) rectangle ($(ur) + (-\inset, -\inset)$);
  
  % Double line effect on sides
  \draw[line width=0.3pt]
    ($(ll) + (\inset*2, \cornersize*1.5)$) -- ($(ul) + (\inset*2, -\cornersize*1.5)$)
    ($(lr) + (-\inset*2, \cornersize*1.5)$) -- ($(ur) + (-\inset*2, -\cornersize*1.5)$);


  \foreach \a in {north west, north east, south west, south east} {
    \fill[blue] (#1.\a) circle[radius=1pt];
  }


}
