\RequirePackage[margin=7mm]{geometry}
\RequirePackage{tikz}
\RequirePackage{times}
\RequirePackage{xcolor}
\RequirePackage{environ}
\RequirePackage{tabularx}
\RequirePackage{booktabs}
\usetikzlibrary{calc}

% Define colors for different sections
\colorlet{stats}{blue!10!white}
\colorlet{proficiencies}{yellow!12!white}
\colorlet{attacks}{orange!25!white}
\colorlet{magic}{red!12!white}
\colorlet{mypurple}{red!40!blue}
\colorlet{features}{magenta!16!white}
\colorlet{playername}{green!90!yellow!8!white}
\colorlet{teal}{blue!40!green}
\colorlet{equipment}{playername}
\colorlet{hpetc}{gray!40!white}

\newif\ifcaster
\casterfalse

% dndbox should create a node

%%  % inside a tikzpicture
%%  \node[minimum width=60mm,   % desired width
%%        minimum height=35mm,  % desired height
%%        inner sep=0pt,        % no extra padding
%%        outer sep=0pt]        % (optional) no extra margin
%%        (MyBox) at (10mm,5mm) {};


% Decorative box macro for D&D character sheets
% Usage: \dndbox{origin}{width}{height}
% where origin may be `x,y` or a coordinate name
\newcommand{\dndbox}[3]{%
  % Parameters: #1 = x,y, #2 = width, #3 = height
  \path (#1) coordinate (dndboxll);
  \dndboxhere{#2}{#3}
}
\newcommand\dndfill[4]{%
  \fill[#4] (#1) +(1mm,1mm) rectangle +(#2-1mm,#3-1mm);
}
\def\south{south}
\newcommand\dndlabeledbox[6][south]{% anchor, add color and label
  \dndfill{#2}{#3}{#4}{#5}
  \dndbox{#2}{#3}{#4}
  \def\anchor{#1}
  \ifx\anchor\south
    \path (#2) ++(#3/2,0mm) node [inner sep=6pt,anchor=#1] {\textsf{#6}};
  \else
    \path (#2) node [inner sep=6pt,anchor=#1] {\textsf{#6}};
  \fi
}
  

\newcommand{\dndboxhere}[2]{%
  \pgfmathsetmacro{\cornersize}{0.15} % Size of corner decorations
  \pgfmathsetmacro{\inset}{0.05} % Inset for inner lines
  
  % Define coordinates
  \path (dndboxll)     coordinate (ll)
             +(#1, 0)  coordinate (lr)
             +(#1, #2) coordinate (ur)
             +(0, #2)  coordinate (ul);
  
  % Main outer frame (heavy lines)
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) -- ($(lr) + (-\cornersize, 0)$)
    ($(lr) + (0, \cornersize)$) -- ($(ur) + (0, -\cornersize)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ul) + (\cornersize, 0)$)
    ($(ul) + (0, -\cornersize)$) -- ($(ll) + (0, \cornersize)$);
  
  % Corner decorations (ornate corners)
  % Lower-left corner
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) arc (0:90:\cornersize)
    ($(ll) + (0, \cornersize)$) -- ($(ll) + (0, \cornersize/2)$)
    ($(ll) + (\cornersize, 0)$) -- ($(ll) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ll) + (\cornersize*0.7, \cornersize*0.3)$) arc (0:90:\cornersize*0.3);
    
  % Lower-right corner
  \draw[line width=1.5pt] 
    ($(lr) + (-\cornersize, 0)$) arc (180:90:\cornersize)
    ($(lr) + (0, \cornersize)$) -- ($(lr) + (0, \cornersize/2)$)
    ($(lr) + (-\cornersize, 0)$) -- ($(lr) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(lr) + (-\cornersize*0.7, \cornersize*0.3)$) arc (180:90:\cornersize*0.3);
    
  % Upper-right corner
  \draw[line width=1.5pt] 
    ($(ur) + (-\cornersize, 0)$) arc (180:270:\cornersize)
    ($(ur) + (0, -\cornersize)$) -- ($(ur) + (0, -\cornersize/2)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ur) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ur) + (-\cornersize*0.7, -\cornersize*0.3)$) arc (180:270:\cornersize*0.3);
    
  % Upper-left corner
  \draw[line width=1.5pt] 
    ($(ul) + (\cornersize, 0)$) arc (0:-90:\cornersize)
    ($(ul) + (0, -\cornersize)$) -- ($(ul) + (0, -\cornersize/2)$)
    ($(ul) + (\cornersize, 0)$) -- ($(ul) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ul) + (\cornersize*0.7, -\cornersize*0.3)$) arc (0:-90:\cornersize*0.3);
  
  % Inner frame lines (lighter)
  \draw[line width=0.5pt]
    ($(ll) + (\inset, \inset)$) rectangle ($(ur) + (-\inset, -\inset)$);
  
  % Double line effect on sides
  \draw[line width=0.3pt]
    ($(ll) + (\inset*2, \cornersize*1.5)$) -- ($(ul) + (\inset*2, -\cornersize*1.5)$)
    ($(lr) + (-\inset*2, \cornersize*1.5)$) -- ($(ur) + (-\inset*2, -\cornersize*1.5)$);
}

\newcommand{\dndboxold}[4]{%
  % Parameters: #1 = x, #2 = y, #3 = width, #4 = height
  \pgfmathsetmacro{\cornersize}{0.15} % Size of corner decorations
  \pgfmathsetmacro{\inset}{0.05} % Inset for inner lines
  
  % Define coordinates
  \coordinate (ll) at (#1, #2);
  \coordinate (lr) at (#1 + #3, #2);
  \coordinate (ul) at (#1, #2 + #4);
  \coordinate (ur) at (#1 + #3, #2 + #4);
  
  % Main outer frame (heavy lines)
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) -- ($(lr) + (-\cornersize, 0)$)
    ($(lr) + (0, \cornersize)$) -- ($(ur) + (0, -\cornersize)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ul) + (\cornersize, 0)$)
    ($(ul) + (0, -\cornersize)$) -- ($(ll) + (0, \cornersize)$);
  
  % Corner decorations (ornate corners)
  % Lower-left corner
  \draw[line width=1.5pt] 
    ($(ll) + (\cornersize, 0)$) arc (0:90:\cornersize)
    ($(ll) + (0, \cornersize)$) -- ($(ll) + (0, \cornersize/2)$)
    ($(ll) + (\cornersize, 0)$) -- ($(ll) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ll) + (\cornersize*0.7, \cornersize*0.3)$) arc (0:90:\cornersize*0.3);
    
  % Lower-right corner
  \draw[line width=1.5pt] 
    ($(lr) + (-\cornersize, 0)$) arc (180:90:\cornersize)
    ($(lr) + (0, \cornersize)$) -- ($(lr) + (0, \cornersize/2)$)
    ($(lr) + (-\cornersize, 0)$) -- ($(lr) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(lr) + (-\cornersize*0.7, \cornersize*0.3)$) arc (180:90:\cornersize*0.3);
    
  % Upper-right corner
  \draw[line width=1.5pt] 
    ($(ur) + (-\cornersize, 0)$) arc (180:270:\cornersize)
    ($(ur) + (0, -\cornersize)$) -- ($(ur) + (0, -\cornersize/2)$)
    ($(ur) + (-\cornersize, 0)$) -- ($(ur) + (-\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ur) + (-\cornersize*0.7, -\cornersize*0.3)$) arc (180:270:\cornersize*0.3);
    
  % Upper-left corner
  \draw[line width=1.5pt] 
    ($(ul) + (\cornersize, 0)$) arc (0:-90:\cornersize)
    ($(ul) + (0, -\cornersize)$) -- ($(ul) + (0, -\cornersize/2)$)
    ($(ul) + (\cornersize, 0)$) -- ($(ul) + (\cornersize/2, 0)$);
  \draw[line width=0.8pt] 
    ($(ul) + (\cornersize*0.7, -\cornersize*0.3)$) arc (0:-90:\cornersize*0.3);
  
  % Inner frame lines (lighter)
  \draw[line width=0.5pt]
    ($(ll) + (\inset, \inset)$) rectangle ($(ur) + (-\inset, -\inset)$);
  
  % Double line effect on sides
  \draw[line width=0.3pt]
    ($(ll) + (\inset*2, \cornersize*1.5)$) -- ($(ul) + (\inset*2, -\cornersize*1.5)$)
    ($(lr) + (-\inset*2, \cornersize*1.5)$) -- ($(ur) + (-\inset*2, -\cornersize*1.5)$);
}

% dndsection environment - stores parameters for use inside tikzpicture

\newlength\dndtextwidth

\NewEnviron{dndsection}[6]{%
  \begingroup
  \newcommand{\dndsectionx}{#1}%
  \newcommand{\dndsectiony}{#2}%
  \newcommand{\dndsectionwidth}{#3}%
  \newcommand{\dndsectionheight}{#4}%
  \newcommand{\dndsectiontitle}{#5}%
  \newcommand{\dndsectioncolor}{#6}%
  % Fill background
  \fill[\dndsectioncolor] (\dndsectionx + 1mm, \dndsectiony + 1mm) rectangle (\dndsectionx + \dndsectionwidth - 1mm, \dndsectiony + \dndsectionheight - 1mm);
  
  % Draw the decorative box
  \dndbox{\dndsectionx,\dndsectiony}{\dndsectionwidth}{\dndsectionheight}
  
  % Place the title at the bottom center
  \node[font=\footnotesize\scshape, anchor=south] at (\dndsectionx + \dndsectionwidth/2, \dndsectiony + 1mm) {\sffamily {\dndsectiontitle}};
  
  % Calculate minipage width
 \setlength{\dndtextwidth}{\dndsectionwidth}
 \addtolength\dndtextwidth{-2\fboxsep}
 \addtolength\dndtextwidth{-2mm}

  % Place content in a minipage
  \node[anchor=north west, inner sep=0] at (\dndsectionx + \fboxsep + 1mm, \dndsectiony+\dndsectionheight - \fboxsep - 1mm) {%
   \begin{minipage}{\dndtextwidth}%
     \BODY%
   \end{minipage}%
  };
  \endgroup
}

\newlength\leftwidth
\newlength\rightwidth
\leftwidth=6.5cm
\rightwidth=12.8cm
\newlength\rightx
\rightx=7.15cm


% Specific section environments with fixed positions
% Use different body names to avoid conflicts
\environbodyname\attacksbody
\NewEnviron{attackssection}{%
  \ifcaster
    \def\y{152mm}%
    \def\h{26mm}
  \else
    \def\y{129mm}%
    \def\h{49mm}
  \fi  
  \begin{dndsection}{\rightx}{\y}{\rightwidth}{\h}{ATTACKS}{attacks}
    \attacksbody
  \end{dndsection}
}[\ignorespacesafterend]
% y = 128mm for noncasters


\environbodyname\featuresbody

%%\NewEnviron{featuressection}{%  noncaster
%%  \begin{dndsection}{\rightx}{55mm}{\rightwidth}{70mm}{FEATURES}{features}
%%    \featuresbody
%%  \end{dndsection}
%%}[\ignorespacesafterend]
%%

\NewEnviron{featuressection}{%  caster
  \begin{dndsection}{\rightx}{0mm}{\rightwidth}{42mm}{FEATURES}{features}
    \featuresbody
  \end{dndsection}
}[\ignorespacesafterend]


\environbodyname\magicbody  
\NewEnviron{magicsection}{%
  \begin{dndsection}{\rightx}{44.5mm}{\rightwidth}{105mm}{MAGIC}{magic}
    \magicbody
  \end{dndsection}
}[\ignorespacesafterend]

\environbodyname\equipmentbody
\NewEnviron{equipmentsection}{%
  \begin{dndsection}{0mm}{0mm}{68mm}{53mm}{EQUIPMENT}{equipment}
    \equipmentbody
  \end{dndsection}
}[\ignorespacesafterend]

\environbodyname\proficienciesbody
\NewEnviron{proficienciessection}{%
  \begin{dndsection}{30mm}{55mm}{38mm}{160mm}{PROFICIENCIES}{proficiencies}
    \proficienciesbody
  \end{dndsection}
}[\ignorespacesafterend]



\newenvironment{nobullets}
  {\begin{list}{}{%
      \setlength{\leftmargin}{0pt}% no indentation
      \setlength{\labelwidth}{0pt}%
      \setlength{\labelsep}{0pt}%
      \setlength{\itemindent}{0pt}%
      \setlength{\topsep}{0pt}% space before/after the list
      \setlength{\partopsep}{0pt}%
      \setlength{\parsep}{0pt}%
      \setlength{\itemsep}{0.5\smallskipamount}% space between items
      \renewcommand*{\makelabel}[1]{}% suppress the bullet
  }}%
  {\end{list}}


\newenvironment{featurestab}
  {\renewcommand\arraystretch{1.5}%
   \begin{tabular}{>{\raggedright\arraybackslash\itshape}p{26mm}>{\raggedright\arraybackslash}p{93mm}}}
  {\end{tabular}}

\newenvironment{spellstab}
  {\renewcommand\arraystretch{1.5}%
   \begin{tabular}{>{\raggedright\arraybackslash\itshape}p{26mm}>{\raggedright\arraybackslash}p{93mm}}}
  {\end{tabular}}

\newcommand\cantripsheader{%
  \multicolumn2{l}{\textsf{CANTRIPS}}%
}

\newcommand{\checkboxes}[1]{%
  \begingroup
  \count0=#1\relax
  \loop
    \ifnum\count0>0
      $\circ$\,
      \ifnum\count0>1~\fi
      \advance\count0 by -1
  \repeat
  \endgroup
}

\newcommand\hpetcll{\rightx + 30mm, 184mm}

\newcommand\hpbackground{
  \fill[hpetc] (\hpetcll) coordinate (hpbackground) rectangle +(98mm,44.5mm);
}

\newcommand\spellsheader[2]{%
  \multicolumn2{l}{\textsf{LEVEL~#1 \checkboxes{#2}/day}}%
}


\newenvironment{attackstab}
  {\renewcommand\arraystretch{1.2}%
   \tabcolsep=0.5\tabcolsep
   \small
   \begin{tabular}{@{}cccccc@{}}
   \multicolumn1{@{}l}{\textsf{NAME}}&
   \textsf{ATTACK}&
   \textsf{DAMAGE}&
   \textsf{TYPE}&
   \textsf{RANGE}&
   \textsf{AMMO}\\
   \midrule
  }
  {\end{tabular}}


