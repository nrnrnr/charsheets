<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet Creator</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        body {
            font-family: tahoma, verdana, arial, sans-serif;
            font-size: 11pt;
            max-width: 52em;
            margin-left: 1em;
            margin-right: 1em;
            background-color: #f9f9f9;
        }
        
        h1 {
            color: #35A;
            border-bottom: 1px solid silver;
            padding-bottom: 4px;
        }
        
        .section {
            margin: 1em 0;
            padding: 1em;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .playername { background-color: #e8f5d0; }
        .stats { background-color: #e6f2ff; }
        .hpetc { background-color: #e6e6e6; }
        .proficiencies { background-color: #fffae6; }
        .attacks { background-color: #ffe6cc; }
        .magic { background-color: #ffe6e6; }
        .features { background-color: #f0e6f7; }
        .equipment { background-color: #e8f5d0; }
        
        .section h2 {
            color: #631;
            margin-top: 0;
            margin-bottom: 0.5em;
        }
        
        .field-group {
            margin-bottom: 0.5em;
        }
        
        .field-row {
            display: flex;
            gap: 1em;
            margin-bottom: 0.5em;
            flex-wrap: wrap;
        }
        
        .field {
            display: flex;
            flex-direction: column;
        }
        
        .field.wide {
            flex: 1;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 0.2em;
            color: #333;
        }
        
        input, textarea, select {
            padding: 0.3em;
            border: 1px solid #999;
            border-radius: 2px;
            font-family: inherit;
            font-size: inherit;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #35A;
            box-shadow: 0 0 3px rgba(53, 170, 170, 0.3);
        }
        
        .ability-scores {
            display: flex;
            gap: 0.5em;
            flex-wrap: wrap;
        }
        
        .ability-scores .field {
            align-items: center;
        }
        
        .ability-scores input {
            width: 3em;
            max-width: 4em;
        }
        
        .list-container {
            border: 1px solid #ccc;
            padding: 0.5em;
            background-color: rgba(255,255,255,0.5);
            border-radius: 2px;
        }
        
        .list-item {
            display: flex;
            gap: 0.5em;
            margin-bottom: 0.3em;
            align-items: center;
        }
        
        .list-item input {
            flex: 1;
        }
        
        .list-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.2em 0.5em;
            border-radius: 2px;
            cursor: pointer;
        }
        
        .add-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.4em 0.8em;
            border-radius: 2px;
            cursor: pointer;
            margin-top: 0.3em;
        }
        
        .attack-item {
            border: 1px solid #ddd;
            padding: 0.5em;
            margin-bottom: 0.5em;
            border-radius: 2px;
            background-color: rgba(255,255,255,0.5);
        }
        
        .attack-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5em;
            margin-bottom: 0.3em;
            padding-left: 4em;
        }
        
        .attack-fields > * {
            flex: 1;
            min-width: 8em;
        }
        
        .attack-fields > *:first-child {
            flex: 2;
            min-width: 12em;
            margin-left: -4em;
        }
        
        .attack-fields .range-field {
            flex: 0 0 10em;
            max-width: 10em;
        }
        
        .attack-fields .ammo-field {
            flex: 0 0 4ch;
            max-width: 4ch;
            width: 4ch;
        }
        
        .attack-fields::after {
            content: '';
            flex: 1;
        }
        
        .spell-level {
            margin-bottom: 1.5em;
            padding: 0.8em;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: rgba(255,255,255,0.3);
        }
        
        .spell-level h3 {
            margin: 0 0 0.5em 0;
            color: #631;
            font-size: 1.1em;
        }
        
        .spell-item {
            border: 1px solid #ddd;
            padding: 0.5em;
            margin-bottom: 0.5em;
            border-radius: 2px;
            background-color: rgba(255,255,255,0.8);
        }
        
        .spells-container {
            margin-bottom: 0.5em;
        }
        
        .feature-item {
            border: 1px solid #ddd;
            padding: 0.5em;
            margin-bottom: 0.5em;
            border-radius: 2px;
            background-color: rgba(255,255,255,0.5);
        }
        
        .feature-item textarea,
        .spell-item textarea {
            resize: vertical;
            width: 100%;
            box-sizing: border-box;
        }
        
        .output-section {
            margin-top: 2em;
            padding: 1em;
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .output-section h2 {
            margin-top: 0;
            color: #631;
        }
        
        #yaml-output {
            width: 100%;
            height: 300px;
            font-family: monospace;
            font-size: 10pt;
            background-color: white;
            border: 1px solid #999;
            padding: 0.5em;
        }
        
        .generate-button {
            background: #35A;
            color: white;
            border: none;
            padding: 0.6em 1.2em;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12pt;
            margin: 1em 0;
        }
        
        .generate-button:hover {
            background: #2a8;
        }
        
        .currency-fields {
            display: flex;
            gap: 1em;
        }
        
        .currency-fields .field {
            min-width: 80px;
        }
        
        kbd {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 0.2em 0.4em;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>D&D Character Sheet Creator</h1>
    <div style="text-align: center; font-size: 0.8em; color: #666; margin-bottom: 1em;">
        Version: blackberry
    </div>
    
    <div style="text-align: center; margin: 1em 0; padding: 1em; background-color: #f4f4f4; border-radius: 4px;">
        <div>
            <input type="file" id="yaml-file" accept=".yaml,.yml" style="display: none;" onchange="loadYAMLFile(event)">
            <button type="button" class="add-button" onclick="document.getElementById('yaml-file').click()">Load YAML File</button>
            <button type="button" class="add-button" onclick="downloadYAML()">Download <tt>character.yaml</tt></button>
            <button type="button" class="generate-button" onclick="generatePDF()">Generate PDF</button>
        </div>
        <div>
            <label>
                <input type="checkbox" id="pregenerated" name="pregenerated">
                Pregenerated character
            </label>
        </div>
    </div>
    
    <div id="status-bar" style="text-align: center; margin: 0.5em 0; font-size: 0.9em; color: #666; min-height: 1.2em;">
        <strong>Tip:</strong> Use <kbd>Ctrl+Enter</kbd> (or <kbd>Cmd+Enter</kbd> on Mac) to quickly add items when focused in Attacks, Spells, or Features sections
    </div>
    
    <form id="character-form">
        <!-- Character Info Section -->
        <div class="section playername">
            <h2>Character Info</h2>
            <div class="field-row">
                <div class="field wide">
                    <label for="character-name">Character Name</label>
                    <input type="text" id="character-name" name="character-name">
                </div>
                <div class="field wide">
                    <label for="player-name">Player Name</label>
                    <input type="text" id="player-name" name="player-name">
                </div>
            </div>
            <div class="field-row">
                <div class="field">
                    <label for="class">Class</label>
                    <select id="class" name="class">
                        <option value="">Select Class</option>
                        <option value="Barbarian">Barbarian</option>
                        <option value="Bard">Bard</option>
                        <option value="Cleric">Cleric</option>
                        <option value="Druid">Druid</option>
                        <option value="Fighter">Fighter</option>
                        <option value="Monk">Monk</option>
                        <option value="Paladin">Paladin</option>
                        <option value="Ranger">Ranger</option>
                        <option value="Rogue">Rogue</option>
                        <option value="Sorcerer">Sorcerer</option>
                        <option value="Warlock">Warlock</option>
                        <option value="Wizard">Wizard</option>
                    </select>
                </div>
                <div class="field">
                    <label for="level">Level</label>
                    <input type="number" id="level" name="level" min="1" max="20">
                </div>
                <div class="field">
                    <label for="race">Race</label>
                    <input type="text" id="race" name="race">
                </div>
            </div>
            <div class="field-row">
                <div class="field wide">
                    <label for="background">Background</label>
                    <input type="text" id="background" name="background">
                </div>
                <div class="field">
                    <label for="alignment">Alignment</label>
                    <input type="text" id="alignment" name="alignment">
                </div>
                <div class="field">
                    <label for="experience">Experience Points</label>
                    <input type="text" id="experience" name="experience">
                </div>
            </div>
            <div class="field-group">
                <label for="motivation">Motivation</label>
                <input type="text" id="motivation" name="motivation" placeholder="Character's personal motivation" style="width: 100%;">
            </div>
        </div>

        <!-- Stats Section -->
        <div class="section stats">
            <h2>Ability Scores</h2>
            <div class="ability-scores">
                <div class="field">
                    <label for="str">Strength</label>
                    <input type="number" id="str" name="str" min="1" max="30">
                </div>
                <div class="field">
                    <label for="dex">Dexterity</label>
                    <input type="number" id="dex" name="dex" min="1" max="30">
                </div>
                <div class="field">
                    <label for="con">Constitution</label>
                    <input type="number" id="con" name="con" min="1" max="30">
                </div>
                <div class="field">
                    <label for="int">Intelligence</label>
                    <input type="number" id="int" name="int" min="1" max="30">
                </div>
                <div class="field">
                    <label for="wis">Wisdom</label>
                    <input type="number" id="wis" name="wis" min="1" max="30">
                </div>
                <div class="field">
                    <label for="cha">Charisma</label>
                    <input type="number" id="cha" name="cha" min="1" max="30">
                </div>
            </div>
        </div>

        <!-- Combat Stats Section -->
        <div class="section hpetc">
            <h2>Combat Stats</h2>
            <div class="field-row">
                <div class="field">
                    <label for="max-hp">Max HP</label>
                    <input type="number" id="max-hp" name="max-hp" min="1">
                </div>
                <div class="field">
                    <label for="hit-dice">Hit Die</label>
                    <select id="hit-dice" name="hit-dice">
                        <option value="">Select</option>
                        <option value="d6">d6</option>
                        <option value="d8">d8</option>
                        <option value="d10">d10</option>
                        <option value="d12">d12</option>
                    </select>
                </div>
            </div>
            <div class="field-row">
                <div class="field">
                    <label for="initiative">Initiative</label>
                    <input type="text" id="initiative" name="initiative" placeholder="+1">
                </div>
                <div class="field">
                    <label for="speed">Speed</label>
                    <input type="text" id="speed" name="speed" placeholder="30">
                </div>
                <div class="field">
                    <label for="armor-class">Armor Class</label>
                    <input type="number" id="armor-class" name="armor-class" min="1">
                </div>
            </div>
            <div class="field-row">
                <div class="field wide">
                    <label for="senses">Senses</label>
                    <input type="text" id="senses" name="senses" placeholder="Darkvision 60 ft.">
                </div>
                <div class="field">
                    <label for="passive-perception">Passive Perception</label>
                    <input type="number" id="passive-perception" name="passive-perception" min="1">
                </div>
            </div>
        </div>

        <!-- Proficiencies Section -->
        <div class="section proficiencies">
            <h2>Proficiencies</h2>
            <div class="field-group" style="display: flex; align-items: center; gap: 0.5em; margin-bottom: 1em;">
                <span>Proficiency Bonus +</span>
                <input type="number" id="proficiency-bonus" name="proficiency-bonus" min="2" max="6" style="width: 2em; text-align: center;" placeholder="2">
            </div>
            <div class="field-group">
                <p>Enter one proficiency per line. Include skill, language, and equipment proficiencies. Leave a blank line between categories.</p>
                <textarea id="proficiencies-text" name="proficiencies-text" rows="8" placeholder="Athletics&#10;Medicine&#10;Nature&#10;&#10;Common&#10;Orcish&#10;&#10;Light Armor&#10;Shield&#10;Simple Weapons" style="width: 100%; box-sizing: border-box;"></textarea>
            </div>
        </div>

        <!-- Attacks Section -->
        <div class="section attacks">
            <h2>Attacks</h2>
            <div id="attacks-list">
                <!-- Dynamic attacks will be added here -->
            </div>
            <button type="button" class="add-button" onclick="addAttack()">Add Attack</button>
        </div>

        <!-- Magic Section -->
        <div class="section magic" id="magic-section">
            <h2 id="magic-header" onclick="toggleMagic()" style="cursor: pointer;">Magic (click to open)</h2>
            <div id="magic-content" style="display: none;">
                <div class="field-group" style="margin-bottom: 1em;">
                    <span>Render:</span>
                    <div style="margin-top: 0.5em;">
                        <label style="display: block; margin-bottom: 0.3em; font-weight: normal;">
                            <input type="radio" name="magic-render" value="normal" checked> at normal size
                        </label>
                        <label style="display: block; margin-bottom: 0.3em; font-weight: normal;">
                            <input type="radio" name="magic-render" value="small"> in a small font
                        </label>
                        <label style="display: block; margin-bottom: 0.3em; font-weight: normal;">
                            <input type="radio" name="magic-render" value="separate"> on a page of its own
                        </label>
                    </div>
                </div>
                <div id="magic-levels">
                    <!-- Spell levels are added dynamically as needed -->
                </div>
                <div id="next-level-button-container">
                    <!-- Next level button will appear here -->
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="section features">
            <h2>Features</h2>
            <div id="features-list">
                <!-- Dynamic features will be added here -->
            </div>
            <button type="button" class="add-button" onclick="addFeature()">Add Feature</button>
        </div>

        <!-- Equipment Section -->
        <div class="section equipment">
            <h2>Equipment</h2>
            <div class="field-group">
                <p>Enter one equipment item per line.</p>
                <textarea id="equipment-text" name="equipment-text" rows="6" placeholder="Scale Mail Armor&#10;Shield (+2 AC)&#10;Backpack&#10;Bedroll&#10;Mess Kit&#10;Torches (10)&#10;Rations (10)&#10;Waterskin" style="width: 100%; box-sizing: border-box;"></textarea>
            </div>
            
            <h3>Currency</h3>
            <div class="currency-fields">
                <div class="field">
                    <label for="cp">Copper (CP)</label>
                    <input type="text" id="cp" name="cp">
                </div>
                <div class="field">
                    <label for="sp">Silver (SP)</label>
                    <input type="text" id="sp" name="sp">
                </div>
                <div class="field">
                    <label for="ep">Electrum (EP)</label>
                    <input type="text" id="ep" name="ep">
                </div>
                <div class="field">
                    <label for="gp">Gold (GP)</label>
                    <input type="text" id="gp" name="gp">
                </div>
                <div class="field">
                    <label for="pp">Platinum (PP)</label>
                    <input type="text" id="pp" name="pp">
                </div>
            </div>
        </div>

    </form>


    <script>
        // Initialize with some default entries
        document.addEventListener('DOMContentLoaded', function() {
            addAttack();
            addFeature();
            setupChangeTracking();
            
            // Initialize and update download button text
            updateDownloadButtonText();
            const characterNameField = document.getElementById('character-name');
            characterNameField.addEventListener('input', updateDownloadButtonText);
            characterNameField.addEventListener('change', updateDownloadButtonText);
        });

        // Global keyboard shortcut handler
        document.addEventListener('keydown', function(event) {
            // Check for Ctrl+Enter (or Cmd+Enter on Mac)
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                
                // Find which section the focus is in
                const activeElement = document.activeElement;
                const attacksSection = document.getElementById('attacks-list');
                const magicSection = document.getElementById('magic-list');
                const featuresSection = document.getElementById('features-list');
                
                // Check if focus is within any of these sections
                if (attacksSection && attacksSection.contains(activeElement)) {
                    addAttack();
                    // Focus on the name field of the new attack
                    setTimeout(() => {
                        const newAttack = document.querySelector('.attack-item:last-child [data-field="name"]');
                        if (newAttack) newAttack.focus();
                    }, 10);
                } else if (magicSection && magicSection.contains(activeElement)) {
                    // Find which spell level section we're in
                    const spellLevelDiv = activeElement.closest('.spell-level');
                    const level = spellLevelDiv ? spellLevelDiv.getAttribute('data-level') : '0';
                    addSpellToLevel(parseInt(level));
                    // Focus on the name field of the new spell
                    setTimeout(() => {
                        const container = spellLevelDiv.querySelector('.spells-container');
                        const newSpell = container ? container.querySelector('.spell-item:last-child [data-field="name"]') : null;
                        if (newSpell) newSpell.focus();
                    }, 10);
                } else if (featuresSection && featuresSection.contains(activeElement)) {
                    addFeature();
                    // Focus on the name field of the new feature
                    setTimeout(() => {
                        const newFeature = document.querySelector('.feature-item:last-child [data-field="name"]');
                        if (newFeature) newFeature.focus();
                    }, 10);
                } else {
                    // If not in a specific section, check which section is closest or most recently used
                    // Default to adding an attack
                    addAttack();
                    setTimeout(() => {
                        const newAttack = document.querySelector('.attack-item:last-child [data-field="name"]');
                        if (newAttack) newAttack.focus();
                    }, 10);
                }
            }
        });

        function toggleMagic() {
            const magicContent = document.getElementById('magic-content');
            const magicHeader = document.getElementById('magic-header');
            
            if (magicContent.style.display === 'none') {
                magicContent.style.display = 'block';
                magicHeader.textContent = 'Magic';
                // Always open cantrips automatically when magic section opens
                if (!document.querySelector('[data-level="0"]')) {
                    openSpellLevel(0);
                }
            } else {
                magicContent.style.display = 'none';
                magicHeader.textContent = 'Magic (click to open)';
            }
        }
        
        function getSpellLevelName(level) {
            if (level === 0) return 'Cantrips';
            const suffixes = ['th', 'st', 'nd', 'rd', 'th', 'th', 'th', 'th', 'th', 'th'];
            return `${level}${suffixes[level]}-Level Spells`;
        }
        
        function openSpellLevel(level) {
            const magicLevels = document.getElementById('magic-levels');
            const levelDiv = document.createElement('div');
            levelDiv.className = 'spell-level';
            levelDiv.setAttribute('data-level', level);
            
            const levelName = level === 0 ? 'Cantrips' : `${getSpellLevelName(level)} (<input type="number" min="0" max="9" maxlength="1" data-slots="${level}" placeholder="0" style="width: 2.5em; border: 1px solid #999; text-align: center;"> slots)`;
            
            levelDiv.innerHTML = `
                <h3>${levelName}</h3>
                <div class="spells-container"></div>
                <button type="button" class="add-button" onclick="addSpellToLevel(${level})">Add ${level === 0 ? 'Cantrip' : getSpellLevelName(level).replace('-Level Spells', '-Level Spell')}</button>
            `;
            
            magicLevels.appendChild(levelDiv);
            
            // Add change tracking for the new slot input if it exists
            const slotsInputEl = levelDiv.querySelector('[data-slots]');
            if (slotsInputEl) {
                slotsInputEl.addEventListener('input', markDirty);
                slotsInputEl.addEventListener('change', markDirty);
            }
            
            updateNextLevelButton();
        }
        
        function showNextLevelButton(level) {
            const container = document.getElementById('next-level-button-container');
            const nextLevel = level;
            const maxLevel = 9;
            
            if (nextLevel <= maxLevel) {
                const levelName = nextLevel === 0 ? 'Cantrips' : getSpellLevelName(nextLevel);
                container.innerHTML = `
                    <button type="button" class="add-button" onclick="openSpellLevel(${nextLevel}); addSpellToLevel(${nextLevel});">Open ${levelName}</button>
                `;
            } else {
                container.innerHTML = '';
            }
        }
        
        function updateNextLevelButton() {
            const existingLevels = Array.from(document.querySelectorAll('.spell-level')).map(el => parseInt(el.getAttribute('data-level')));
            if (existingLevels.length === 0) {
                showNextLevelButton(0);
                return;
            }
            
            const maxExistingLevel = Math.max(...existingLevels);
            const nextLevel = maxExistingLevel + 1;
            showNextLevelButton(nextLevel);
        }

        function addAttack() {
            const container = document.getElementById('attacks-list');
            const item = document.createElement('div');
            item.className = 'attack-item';
            item.innerHTML = `
                <div class="attack-fields">
                    <input type="text" placeholder="Weapon" data-field="name" />
                    <input type="text" placeholder="Attack Bonus" data-field="attack" />
                    <input type="text" placeholder="Damage Amount" data-field="damage" />
                    <input type="text" placeholder="Damage Type" data-field="type" list="damage-types" />
                    <datalist id="damage-types">
                        <option value="slashing">
                        <option value="piercing">
                        <option value="bludgeoning">
                        <option value="acid">
                        <option value="cold">
                        <option value="fire">
                        <option value="force">
                        <option value="lightning">
                        <option value="necrotic">
                        <option value="poison">
                        <option value="psychic">
                        <option value="radiant">
                        <option value="thunder">
                        <option value="slashing/cold">
                        <option value="piercing/fire">
                        <option value="bludgeoning/thunder">
                    </datalist>
                    <input type="text" placeholder="Range" data-field="range" class="range-field" />
                    <input type="text" placeholder="Ammo" data-field="ammo" class="ammo-field" />
                </div>
                <button type="button" onclick="this.parentElement.remove()">Remove Attack</button>
            `;
            container.appendChild(item);
            
            // Add change tracking to new elements
            item.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', markDirty);
                el.addEventListener('change', markDirty);
            });
        }

        function addSpellToLevel(level) {
            // Ensure the level exists first
            let spellLevelDiv = document.querySelector(`[data-level="${level}"]`);
            if (!spellLevelDiv) {
                openSpellLevel(level);
                spellLevelDiv = document.querySelector(`[data-level="${level}"]`);
            }
            
            const spellContainer = spellLevelDiv.querySelector('.spells-container');
            const item = document.createElement('div');
            item.className = 'spell-item';
            item.innerHTML = `
                <div class="field-group">
                    <label>Name</label>
                    <input type="text" placeholder="e.g., Magic Missile" data-field="name" data-level="${level}" />
                </div>
                <div class="field-group">
                    <label>Description</label>
                    <textarea placeholder="Spell description..." data-field="description" rows="2"></textarea>
                </div>
                <button type="button" onclick="this.parentElement.remove(); setupChangeTracking();">Remove Spell</button>
            `;
            spellContainer.appendChild(item);
            
            // Add change tracking to new elements
            item.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', markDirty);
                el.addEventListener('change', markDirty);
            });
        }
        
        // Legacy function for compatibility
        function addSpell() {
            addSpellToLevel(0); // Default to cantrips
        }

        function addFeature() {
            const container = document.getElementById('features-list');
            const item = document.createElement('div');
            item.className = 'feature-item';
            item.innerHTML = `
                <div class="field-group">
                    <label>Name</label>
                    <input type="text" placeholder="e.g., Rage, Darkvision" data-field="name" />
                </div>
                <div class="field-group">
                    <label>Description</label>
                    <textarea placeholder="Feature description..." data-field="description" rows="2"></textarea>
                </div>
                <button type="button" onclick="this.parentElement.remove()">Remove Feature</button>
            `;
            container.appendChild(item);
            
            // Add change tracking to new elements
            item.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', markDirty);
                el.addEventListener('change', markDirty);
            });
        }

        let isDirty = false;
        let loadedFileName = '';

        function loadYAMLFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        parseYAMLIntoForm(e.target.result);
                        loadedFileName = file.name;
                        isDirty = false;
                        updateStatusBar();
                        setupChangeTracking();
                        updateDownloadButtonText();
                    } catch (error) {
                        updateStatusBar('Error loading YAML file: ' + error.message, true);
                    }
                };
                reader.readAsText(file);
            }
        }

        function updateStatusBar(message = null, isError = false) {
            const statusBar = document.getElementById('status-bar');
            if (message) {
                statusBar.innerHTML = `<span style="color: ${isError ? '#d32f2f' : '#666'}">${message}</span>`;
            } else if (loadedFileName) {
                const dirtyMark = isDirty ? ' (dirty)' : '';
                statusBar.innerHTML = `Loaded from <strong>${loadedFileName}</strong>${dirtyMark}`;
            } else {
                statusBar.innerHTML = '<strong>Tip:</strong> Use <kbd>Ctrl+Enter</kbd> (or <kbd>Cmd+Enter</kbd> on Mac) to quickly add items when focused in Attacks, Spells, or Features sections';
            }
        }

        function markDirty() {
            if (!isDirty) {
                isDirty = true;
                updateStatusBar();
            }
        }

        function setupChangeTracking() {
            // Remove existing listeners first
            document.querySelectorAll('#character-form input, #character-form textarea, #character-form select').forEach(el => {
                el.removeEventListener('input', markDirty);
                el.removeEventListener('change', markDirty);
            });
            
            // Add listeners to all form elements
            document.querySelectorAll('#character-form input, #character-form textarea, #character-form select').forEach(el => {
                el.addEventListener('input', markDirty);
                el.addEventListener('change', markDirty);
                // Update button text when character name changes
                if (el.id === 'character-name') {
                    el.addEventListener('input', updateDownloadButtonText);
                }
            });
        }

        function parseYAMLIntoForm(yamlText) {
            const form = document.getElementById('character-form');
            
            try {
                // Use js-yaml to parse the YAML
                const data = jsyaml.load(yamlText);
                if (!data) return;
                
                // Character info fields
                const setFormValue = (selector, value) => {
                    const el = form.querySelector(selector);
                    if (el && value !== undefined && value !== null) {
                        el.value = value.toString();
                    }
                };
                
                setFormValue('#character-name', data['CHARACTER NAME']);
                setFormValue('#player-name', data['PLAYER NAME']);
                setFormValue('#race', data['RACE']);
                setFormValue('#background', data['BACKGROUND']);
                setFormValue('#alignment', data['ALIGNMENT']);
                setFormValue('#experience', data['EXPERIENCE POINTS']);
                setFormValue('#motivation', data['MOTIVATION']);
                
                // Pregenerated checkbox
                const pregeneratedEl = document.querySelector('#pregenerated');
                if (pregeneratedEl) {
                    const pregeneratedValue = data['PREGENERATED'];
                    console.log('PREGENERATED value:', pregeneratedValue, 'type:', typeof pregeneratedValue);
                    // Use ifDNDfalse helper function - note: ifDNDfalse returns true when LaTeX would be false
                    const shouldCheck = !ifDNDfalse(pregeneratedValue);
                    console.log('Should check:', shouldCheck);
                    pregeneratedEl.checked = shouldCheck;
                }
                
                // Handle "CLASS & LEVEL" first if present
                if (data['CLASS & LEVEL']) {
                    const classLevel = data['CLASS & LEVEL'].toString();
                    // Handle "Cleric (Life Domain) 3" format
                    const match = classLevel.match(/^([A-Za-z]+)(?:\s+\([^)]+\))?\s+(\d+)$/) || 
                                 classLevel.match(/^([A-Za-z]+)\s+(\d+)$/) || 
                                 classLevel.match(/^([A-Za-z]+)/);
                    if (match) {
                        setFormValue('#class', match[1]);
                        if (match[2]) setFormValue('#level', match[2]);
                    }
                }
                
                // Override with individual CLASS if present
                if (data['CLASS']) {
                    setFormValue('#class', data['CLASS']);
                }
                
                // Override with individual LEVEL if present
                if (data['LEVEL']) {
                    setFormValue('#level', data['LEVEL']);
                }
                
                // Ability scores
                setFormValue('#str', data['STR']);
                setFormValue('#dex', data['DEX']);
                setFormValue('#con', data['CON']);
                setFormValue('#int', data['INT']);
                setFormValue('#wis', data['WIS']);
                setFormValue('#cha', data['CHA']);
                
                // Combat stats
                setFormValue('#proficiency-bonus', data['PROFICIENCY BONUS']);
                setFormValue('#max-hp', data['MAX HP']);
                setFormValue('#hit-dice', data['HIT DICE']);
                setFormValue('#initiative', data['INITIATIVE']);
                setFormValue('#speed', data['SPEED']);
                setFormValue('#armor-class', data['ARMOR CLASS']);
                setFormValue('#senses', data['SENSES']);
                setFormValue('#passive-perception', data['PASSIVE PERCEPTION']);
                
                // Currency
                setFormValue('#cp', data['CP']);
                setFormValue('#sp', data['SP']);
                setFormValue('#ep', data['EP']);
                setFormValue('#gp', data['GP']);
                setFormValue('#pp', data['PP']);
                
                // Proficiencies
                if (data['PROFICIENCIES'] && Array.isArray(data['PROFICIENCIES'])) {
                    const profList = data['PROFICIENCIES'].map(item => {
                        if (typeof item === 'string') return item;
                        if (typeof item === 'object' && item === null) return ''; // blank separator
                        if (item && item.proficiencies_skip) return '';
                        if (item && typeof item === 'object') {
                            // Handle objects like {Languages: "Common"}, {Armor: "Light"}
                            const keys = Object.keys(item);
                            if (keys.length === 1) {
                                const key = keys[0];
                                const value = item[key];
                                if (key === 'Languages') return value;
                                if (key === 'Armor') return `${value} Armor`;
                                if (key === 'Weapons') return `${value} Weapons`;
                                return `${key}: ${value}`;
                            }
                        }
                        return item?.toString() || '';
                    });
                    setFormValue('#proficiencies-text', profList.join('\n'));
                }
                
                // Equipment
                if (data['EQUIPMENT'] && Array.isArray(data['EQUIPMENT'])) {
                    const equipList = data['EQUIPMENT'].map(item => item?.toString() || '');
                    setFormValue('#equipment-text', equipList.join('\n'));
                }
                
                // Features
                if (data['FEATURES'] && Array.isArray(data['FEATURES'])) {
                    // Clear existing features first
                    document.querySelectorAll('.feature-item').forEach(item => item.remove());
                    
                    data['FEATURES'].forEach(feature => {
                        if (feature && typeof feature === 'object' && feature.name) {
                            addFeature();
                            const items = document.querySelectorAll('.feature-item');
                            const lastItem = items[items.length - 1];
                            if (lastItem) {
                                const nameEl = lastItem.querySelector('[data-field="name"]');
                                const descEl = lastItem.querySelector('[data-field="description"]');
                                if (nameEl) nameEl.value = feature.name || '';
                                if (descEl) descEl.value = feature.description || '';
                            }
                        }
                    });
                }
                
                // Attacks
                if (data['ATTACKS'] && Array.isArray(data['ATTACKS'])) {
                    // Clear existing attacks first
                    document.querySelectorAll('.attack-item').forEach(item => item.remove());
                    
                    data['ATTACKS'].forEach(attack => {
                        if (attack && typeof attack === 'object') {
                            addAttack();
                            const items = document.querySelectorAll('.attack-item');
                            const lastItem = items[items.length - 1];
                            if (lastItem) {
                                const nameEl = lastItem.querySelector('[data-field="name"]');
                                const attackEl = lastItem.querySelector('[data-field="attack"]');
                                const damageEl = lastItem.querySelector('[data-field="damage"]');
                                const typeEl = lastItem.querySelector('[data-field="type"]');
                                const rangeEl = lastItem.querySelector('[data-field="range"]');
                                const ammoEl = lastItem.querySelector('[data-field="ammo"]');
                                
                                if (nameEl) nameEl.value = attack['NAME'] || '';
                                if (attackEl) attackEl.value = attack['ATTACK'] || '';
                                if (damageEl) damageEl.value = attack['DAMAGE'] || '';
                                if (typeEl) typeEl.value = attack['TYPE'] || '';
                                if (rangeEl) rangeEl.value = attack['RANGE'] || '';
                                if (ammoEl) ammoEl.value = attack['AMMO'] || '';
                            }
                        }
                    });
                }
                
                // Magic/Spells
                if (data['MAGIC'] && Array.isArray(data['MAGIC'])) {
                    // Auto-open magic section
                    const magicContent = document.getElementById('magic-content');
                    const magicHeader = document.getElementById('magic-header');
                    if (magicContent && magicContent.style.display === 'none') {
                        magicContent.style.display = 'block';
                        magicHeader.textContent = 'Magic';
                    }
                    
                    // Clear existing spells and levels first
                    document.getElementById('magic-levels').innerHTML = '';
                    document.getElementById('next-level-button-container').innerHTML = '';
                    
                    // Process each magic entry
                    let currentLevel = null;
                    data['MAGIC'].forEach(spell => {
                        if (spell && typeof spell === 'object') {
                            // Handle level markers with slot information
                            if (spell.level !== undefined && !spell.name) {
                                currentLevel = spell.level;
                                // If this is a level with slot information, handle slots
                                if (typeof spell.level === 'object' && spell.level.number !== undefined) {
                                    currentLevel = spell.level.number;
                                    // Ensure the level exists before setting slots
                                    if (!document.querySelector(`[data-level="${currentLevel}"]`)) {
                                        openSpellLevel(currentLevel);
                                    }
                                    const slotsInput = document.querySelector(`[data-slots="${currentLevel}"]`);
                                    if (slotsInput && spell.level.slots !== undefined) {
                                        slotsInput.value = spell.level.slots;
                                    }
                                } else if (typeof spell.level === 'number') {
                                    currentLevel = spell.level;
                                }
                                return;
                            }
                            
                            // Add spell with name and description
                            if (spell.name && currentLevel !== null) {
                                addSpellToLevel(currentLevel);
                                const levelContainer = document.querySelector(`[data-level="${currentLevel}"] .spells-container`);
                                if (levelContainer) {
                                    const items = levelContainer.querySelectorAll('.spell-item');
                                    const lastItem = items[items.length - 1];
                                    if (lastItem) {
                                        const nameEl = lastItem.querySelector('[data-field="name"]');
                                        const descEl = lastItem.querySelector('[data-field="description"]');
                                        
                                        if (nameEl) nameEl.value = spell.name || '';
                                        if (descEl) descEl.value = spell.description || '';
                                    }
                                }
                            }
                        }
                    });
                    
                    // Update the next level button after loading
                    updateNextLevelButton();
                }

                // Handle magic rendering options
                let magicRenderOption = 'normal'; // default
                
                if (data['MAGIC SEPARATE'] && !ifDNDfalse(data['MAGIC SEPARATE'])) {
                    magicRenderOption = 'separate';
                } else if (data['MAGIC FONT'] && typeof data['MAGIC FONT'] === 'string') {
                    const magicFont = data['MAGIC FONT'].toString();
                    if (magicFont.includes('small')) {
                        magicRenderOption = 'small';
                    } else if (magicFont.includes('normalsize')) {
                        magicRenderOption = 'normal';
                    }
                }
                
                // Set the radio button
                const radioToCheck = document.querySelector(`input[name="magic-render"][value="${magicRenderOption}"]`);
                if (radioToCheck) {
                    radioToCheck.checked = true;
                }
                
            } catch (error) {
                throw new Error('YAML parsing failed: ' + error.message);
            }
        }


        function ifDNDfalse(value) {
            // Following \ifDNDfalse semantics: undefined, empty, "0", or "false" are false
            // Convert to string for comparison to handle both numeric and string values
            if (value === undefined || value === null) return true;
            const valueStr = value.toString().toLowerCase();
            return valueStr === '' || valueStr === '0' || valueStr === 'false';
        }

        function createYAMLContent() {
            const form = document.getElementById('character-form');
            const data = {};

            // Character Info (all required fields always included)
            const characterName = form.querySelector('#character-name')?.value || '';
            const playerName = form.querySelector('#player-name')?.value || '';
            const characterClass = form.querySelector('#class')?.value || '';
            const level = form.querySelector('#level')?.value || '';
            const race = form.querySelector('#race')?.value || '';
            const background = form.querySelector('#background')?.value || '';
            const alignment = form.querySelector('#alignment')?.value || '';
            const experience = form.querySelector('#experience')?.value || '';
            const motivation = form.querySelector('#motivation')?.value || '';

            // Required fields - always include even if empty
            data['CHARACTER NAME'] = characterName;
            data['PLAYER NAME'] = playerName;
            data['CLASS'] = characterClass;
            data['LEVEL'] = parseInt(level) || level;
            data['RACE'] = race;
            data['BACKGROUND'] = background;
            data['ALIGNMENT'] = alignment;
            data['EXPERIENCE POINTS'] = experience;
            if (motivation) data['MOTIVATION'] = motivation;
            
            // Pregenerated
            const pregenerated = document.querySelector('#pregenerated')?.checked || false;
            if (pregenerated) data['PREGENERATED'] = true;

            // Ability Scores (all required)
            const str = form.querySelector('#str')?.value || '';
            const dex = form.querySelector('#dex')?.value || '';
            const con = form.querySelector('#con')?.value || '';
            const int = form.querySelector('#int')?.value || '';
            const wis = form.querySelector('#wis')?.value || '';
            const cha = form.querySelector('#cha')?.value || '';

            data['STR'] = parseInt(str) || str;
            data['DEX'] = parseInt(dex) || dex;
            data['CON'] = parseInt(con) || con;
            data['INT'] = parseInt(int) || int;
            data['WIS'] = parseInt(wis) || wis;
            data['CHA'] = parseInt(cha) || cha;

            // Combat Stats (all required)
            const profBonus = form.querySelector('#proficiency-bonus')?.value || '';
            const maxHp = form.querySelector('#max-hp')?.value || '';
            const hitDice = form.querySelector('#hit-dice')?.value || '';
            const initiative = form.querySelector('#initiative')?.value || '';
            const speed = form.querySelector('#speed')?.value || '';
            const ac = form.querySelector('#armor-class')?.value || '';
            const senses = form.querySelector('#senses')?.value || '';
            const passivePerc = form.querySelector('#passive-perception')?.value || '';

            data['PROFICIENCY BONUS'] = profBonus;
            data['MAX HP'] = parseInt(maxHp) || maxHp;
            data['CURRENT HIT POINTS'] = '';  // Required, typically empty
            data['HIT DICE'] = hitDice;
            data['INITIATIVE'] = initiative;
            data['SPEED'] = speed;
            data['ARMOR CLASS'] = parseInt(ac) || ac;
            data['SENSES'] = senses;
            data['PASSIVE PERCEPTION'] = parseInt(passivePerc) || passivePerc;

            // Proficiencies (required)
            const proficienciesText = form.querySelector('#proficiencies-text')?.value || '';
            data['PROFICIENCIES'] = [];
            if (proficienciesText.trim()) {
                proficienciesText.split('\n').forEach(line => {
                    line = line.trim();
                    if (line) {
                        data['PROFICIENCIES'].push(line);
                    } else {
                        data['PROFICIENCIES'].push(null); // Separator
                    }
                });
            }

            // Attacks (required, can be empty list)
            const attacks = [];
            document.querySelectorAll('.attack-item').forEach(attackDiv => {
                const name = attackDiv.querySelector('[data-field="name"]')?.value || '';
                const attack = attackDiv.querySelector('[data-field="attack"]')?.value || '';
                const damage = attackDiv.querySelector('[data-field="damage"]')?.value || '';
                const type = attackDiv.querySelector('[data-field="type"]')?.value || '';
                const range = attackDiv.querySelector('[data-field="range"]')?.value || '';
                const ammo = attackDiv.querySelector('[data-field="ammo"]')?.value || '';

                if (name || attack || damage || type || range || ammo) {
                    attacks.push({
                        'NAME': name,
                        'ATTACK': attack,
                        'DAMAGE': damage,
                        'TYPE': type,
                        'RANGE': range,
                        'AMMO': ammo
                    });
                }
            });
            data['ATTACKS'] = attacks;

            // Magic (only include when not empty)
            const magic = [];
            const magicLevels = document.querySelectorAll('.spell-level');
            let hasMagic = false;
            
            magicLevels.forEach(levelDiv => {
                const level = levelDiv.getAttribute('data-level');
                const spellItems = levelDiv.querySelectorAll('.spell-item');
                const slotsInput = levelDiv.querySelector(`[data-slots="${level}"]`);
                
                if (spellItems.length > 0) {
                    // Add level header with slot information
                    if (level === '0') {
                        magic.push({ level: 0 });
                    } else {
                        const slots = slotsInput?.value || '';
                        if (slots) {
                            magic.push({ level: { number: parseInt(level), slots: parseInt(slots) } });
                        } else {
                            magic.push({ level: parseInt(level) });
                        }
                    }
                    
                    // Add spells for this level
                    spellItems.forEach(spellDiv => {
                        const name = spellDiv.querySelector('[data-field="name"]')?.value || '';
                        const description = spellDiv.querySelector('[data-field="description"]')?.value || '';
                        
                        if (name || description) {
                            hasMagic = true;
                            const spell = {};
                            if (name) spell.name = name;
                            if (description) spell.description = description;
                            magic.push(spell);
                        }
                    });
                }
            });
            
            if (hasMagic) {
                data['MAGIC'] = magic;
            }

            // Magic rendering options
            const magicRenderOption = document.querySelector('input[name="magic-render"]:checked')?.value;
            if (magicRenderOption === 'small') {
                data['MAGIC FONT'] = '\\small';
            } else if (magicRenderOption === 'separate') {
                data['MAGIC SEPARATE'] = true;
            }

            // Features (required, can be empty list)
            const features = [];
            document.querySelectorAll('.feature-item').forEach(featureDiv => {
                const name = featureDiv.querySelector('[data-field="name"]')?.value || '';
                const description = featureDiv.querySelector('[data-field="description"]')?.value || '';

                if (name || description) {
                    const feature = {};
                    if (name) feature.name = name;
                    if (description) feature.description = description;
                    features.push(feature);
                }
            });
            data['FEATURES'] = features;

            // Equipment (required, can be empty list)
            const equipmentText = form.querySelector('#equipment-text')?.value || '';
            data['EQUIPMENT'] = [];
            if (equipmentText.trim()) {
                equipmentText.split('\n').forEach(line => {
                    line = line.trim();
                    if (line) {
                        data['EQUIPMENT'].push(line);
                    }
                });
            }

            // Currency (all required, can be empty)
            const cp = form.querySelector('#cp')?.value || '';
            const sp = form.querySelector('#sp')?.value || '';
            const ep = form.querySelector('#ep')?.value || '';
            const gp = form.querySelector('#gp')?.value || '';
            const pp = form.querySelector('#pp')?.value || '';

            data['CP'] = cp;
            data['SP'] = sp;
            data['EP'] = ep;
            data['GP'] = gp;
            data['PP'] = pp;

            // Use js-yaml to serialize the data structure
            return jsyaml.dump(data, { 
                indent: 2,
                noRefs: true,
                sortKeys: false 
            });
        }

        function generateYAML() {
            document.getElementById('yaml-output').value = createYAMLContent();
        }

        function copyYAML() {
            const yamlOutput = document.getElementById('yaml-output');
            yamlOutput.select();
            document.execCommand('copy');
            alert('YAML copied to clipboard!');
        }

        function updateDownloadButtonText() {
            const characterName = document.getElementById('character-name').value.trim() || 'character';
            const filename = characterName.toLowerCase().replace(/[^a-z0-9]/g, '-') + '.yaml';
            const downloadButton = document.querySelector('[onclick="downloadYAML()"]');
            downloadButton.innerHTML = `Download <tt>${filename}</tt>`;
        }
        
        function downloadYAML() {
            let yamlContent = document.getElementById('yaml-output').value;
            if (!yamlContent.trim()) {
                // Auto-generate YAML if it doesn't exist
                generateYAML();
                yamlContent = document.getElementById('yaml-output').value;
            }

            const characterName = document.getElementById('character-name').value.trim() || 'character';
            const filename = characterName.toLowerCase().replace(/[^a-z0-9]/g, '-') + '.yaml';
            
            const blob = new Blob([yamlContent], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function getCharacterFilename(extension = 'yaml') {
            // Get character name and clean it for filename use
            const characterName = (document.querySelector('#character-name')?.value || 'character').trim();
            // Replace spaces (including non-breaking spaces) with regular spaces, then convert to dash
            const cleanName = characterName.toLowerCase()
                .replace(/[\s\u00A0]+/g, '-')  // Replace spaces and non-breaking spaces with dash
                .replace(/[^a-z0-9-]/g, '')   // Remove other non-alphanumeric chars except dash
                .replace(/--+/g, '-')         // Replace multiple dashes with single dash
                .replace(/^-+|-+$/g, '')      // Remove leading/trailing dashes
                || 'character';
            return `${cleanName}.${extension}`;
        }

        function updateDownloadButtonText() {
            const downloadButton = document.querySelector('button[onclick="downloadYAML()"]');
            if (downloadButton) {
                const filename = getCharacterFilename();
                downloadButton.innerHTML = `Download <tt>${filename}</tt>`;
            }
        }

        function downloadYAML() {
            // Generate YAML content using the shared function
            const yamlContent = createYAMLContent();
            
            // Use consistent filename
            const filename = getCharacterFilename();
            
            // Create download
            const blob = new Blob([yamlContent], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function generatePDF() {
            try {
                // Generate YAML content using the shared function
                const yamlContent = createYAMLContent();
                
                // Send to server and let browser handle the response completely
                // Use form submission to let browser handle response naturally
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/charsheet/render.cgi';
                form.target = '_blank'; // Open result in new window
                form.enctype = 'text/plain';
                form.style.display = 'none';
                
                const textarea = document.createElement('textarea');
                textarea.name = 'yaml';
                textarea.value = yamlContent;
                
                form.appendChild(textarea);
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`Failed to generate PDF: ${error.message}. Please check that the server is running and accessible.`);
            }
        }
    </script>
</body>
</html>